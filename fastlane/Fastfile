default_platform(:ios)

TEAMID = ENV["TEAMID"]
GH_PAT = ENV["GH_PAT"]
GITHUB_WORKSPACE = ENV["GITHUB_WORKSPACE"]
GITHUB_REPOSITORY_OWNER = ENV["GITHUB_REPOSITORY_OWNER"]
FASTLANE_KEY_ID = ENV["FASTLANE_KEY_ID"]
FASTLANE_ISSUER_ID = ENV["FASTLANE_ISSUER_ID"]
FASTLANE_KEY = ENV["FASTLANE_KEY"]
ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"

# ---------- Bundle ID handling ----------
xcconfig_path = "#{GITHUB_WORKSPACE}/Config.xcconfig"

if File.exist?(xcconfig_path)
  File.readlines(xcconfig_path).each do |line|
    if line.strip.start_with?("BUNDLE_IDENTIFIER")
      ENV["BUNDLE_ID"] = line.split("=").last.strip
    end
  end
end

# Hard fallback (intentional)
ENV["BUNDLE_ID"] ||= "org.dsharpe15.Trio"

puts "âœ… Fastlane using BUNDLE_ID: #{ENV["BUNDLE_ID"]}"

# ---------- iOS ----------
platform :ios do

  desc "Build Trio"
  lane :build_trio do
    setup_ci if ENV["CI"]
    BUNDLE_ID = ENV["BUNDLE_ID"]

    update_project_team(
      path: "#{GITHUB_WORKSPACE}/FreeAPS.xcodeproj",
      teamid: TEAMID
    )

    api_key = app_store_connect_api_key(
      key_id: FASTLANE_KEY_ID,
      issuer_id: FASTLANE_ISSUER_ID,
      key_content: FASTLANE_KEY
    )

    previous_build_number = latest_testflight_build_number(
      app_identifier: BUNDLE_ID,
      api_key: api_key
    ) rescue 0

    increment_build_number(
      xcodeproj: "#{GITHUB_WORKSPACE}/FreeAPS.xcodeproj",
      build_number: previous_build_number + 1
    )

    match(
      type: "appstore",
      git_basic_authorization: Base64.strict_encode64("#{GITHUB_REPOSITORY_OWNER}:#{GH_PAT}"),
      app_identifier: [
        BUNDLE_ID,
        "#{BUNDLE_ID}.watchkitapp",
        "#{BUNDLE_ID}.watchkitapp.watchkitextension",
        "#{BUNDLE_ID}.LiveActivity"
      ]
    )

    gym(
      scheme: "Trio",
      export_method: "app-store",
      configuration: "Release",
      output_name: "Trio.ipa",
      destination: "generic/platform=iOS",
      buildlog_path: "buildlog"
    )

    copy_artifacts(
      target_path: "artifacts",
      artifacts: ["*.ipa", "*.dSYM.zip"]
    )
  end

  desc "Upload to TestFlight"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: FASTLANE_KEY_ID,
      issuer_id: FASTLANE_ISSUER_ID,
      key_content: FASTLANE_KEY
    )

    upload_to_testflight(
      api_key: api_key,
      ipa: "Trio.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Check and renew certificates"
  lane :check_and_renew_certificates do
    setup_ci if ENV["CI"]
    ENV["MATCH_READONLY"] = "false"

    app_store_connect_api_key(
      key_id: FASTLANE_KEY_ID,
      issuer_id: FASTLANE_ISSUER_ID,
      key_content: FASTLANE_KEY
    )

    match(
      type: "appstore",
      git_basic_authorization: Base64.strict_encode64("#{GITHUB_REPOSITORY_OWNER}:#{GH_PAT}"),
      app_identifier: [
        ENV["BUNDLE_ID"],
        "#{ENV["BUNDLE_ID"]}.watchkitapp",
        "#{ENV["BUNDLE_ID"]}.watchkitapp.watchkitextension",
        "#{ENV["BUNDLE_ID"]}.LiveActivity"
      ]
    )
  end
end

